<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="f_ : Asynchronous Node.js made easy and fun!">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>f_</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/opensoars/f_">View on GitHub</a>

          <h1 id="project_title">f_</h1>
          <h2 id="project_tagline">Asynchronous Node.js made easy and fun!</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/opensoars/f_/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/opensoars/f_/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="f_-flow-flow" class="anchor" href="#f_-flow-flow"><span class="octicon octicon-link"></span></a>f_ (f.low, flow)</h1>

<p><a href="https://travis-ci.org/opensoars/f_"><img src="https://img.shields.io/travis/opensoars/f_.svg?style=flat" alt="Build Status"></a>
<a href="https://coveralls.io/r/opensoars/f_"><img src="https://img.shields.io/coveralls/opensoars/f_.svg?style=flat" alt="Coverage Status"></a>
<a href="https://david-dm.org/opensoars/f_"><img src="https://david-dm.org/opensoars/f_.svg?style=flat" alt="Dependency Status"></a>
<a href="https://david-dm.org/opensoars/f_#info=devDependencies&amp;view=table"><img src="https://david-dm.org/opensoars/f_/dev-status.svg?style=flat" alt="Development Dependency Status"></a></p>

<p><a href="https://www.npmjs.org/package/f_"><img src="https://nodei.co/npm/f_.png?compact=true" alt="NPM"></a></p>

<hr>

<h3>
<a name="dependencies" class="anchor" href="#dependencies"><span class="octicon octicon-link"></span></a>Dependencies</h3>

<ul>
<li><a href="https://github.com/opensoars/cls">cls</a></li>
<li><a href="https://github.com/opensoars/ezlog">ezlog</a></li>
</ul>

<h3>
<a name="examples" class="anchor" href="#examples"><span class="octicon octicon-link"></span></a>Examples</h3>

<p>Click <a href="https://github.com/opensoars/f_/tree/master/doc/examples">here</a> to browse f_ examples. Altogether they will cover everything f_ has to offer.</p>

<h3>
<a name="run-tests-and-get-coverage-lcov-report" class="anchor" href="#run-tests-and-get-coverage-lcov-report"><span class="octicon octicon-link"></span></a>Run tests and get coverage (lcov) report</h3>

<p><code>npm run localTest</code></p>

<h3>
<a name="basic-usage" class="anchor" href="#basic-usage"><span class="octicon octicon-link"></span></a>Basic usage</h3>

<div class="highlight highlight-js"><pre><span class="kd">var</span> <span class="nx">f_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'f_'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">TaskList</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'TaskList.js'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">f_config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">functionFlow</span><span class="o">:</span> <span class="p">[</span><span class="s1">'firstMethod'</span><span class="p">,</span> <span class="s1">'secondMethod'</span><span class="p">,</span> <span class="s1">'lastMethod'</span><span class="p">]</span>
<span class="p">};</span>

<span class="c1">// Augment a task list class.</span>
<span class="nx">TaskList</span> <span class="o">=</span> <span class="nx">f_</span><span class="p">.</span><span class="nx">augment</span><span class="p">(</span><span class="nx">TaskList</span><span class="p">,</span> <span class="nx">f_config</span><span class="p">);</span>

<span class="c1">// Setup a task list instance.</span>
<span class="kd">var</span> <span class="nx">taskListInstance</span> <span class="o">=</span> <span class="nx">f_</span><span class="p">.</span><span class="nx">setup</span><span class="p">(</span> <span class="k">new</span> <span class="nx">TaskList</span><span class="p">()</span> <span class="p">);</span>

<span class="c1">// Call task list it's self written start method.</span>
<span class="c1">// taskListInstance.start(); will call f_next();</span>
<span class="nx">taskListInstance</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</pre></div>

<hr>

<h3>
<a name="todo" class="anchor" href="#todo"><span class="octicon octicon-link"></span></a>Todo</h3>

<ul>
<li>Write a cleanup method that can be called by users!</li>
<li>Write more <a href="https://github.com/opensoars/f_/tree/master/doc/examples">examples</a>
</li>
<li>Write memory tests using <a href="https://github.com/opensoars/raminfo">raminfo</a>
</li>
<li>Complete <a href="https://github.com/opensoars/f_#documentation-outdated">documentation</a>
</li>
</ul>

<h3>
<a name="time-schedule-from-the-10th-of-september-2014" class="anchor" href="#time-schedule-from-the-10th-of-september-2014"><span class="octicon octicon-link"></span></a>Time schedule (from the 10th of September 2014)</h3>

<ul>
<li>
<p>1.5/2 weeks (will result in pre-alpha release)</p>

<ul>
<li>Further brainstorming</li>
<li>Expand documentation all features</li>
<li>Complete features</li>
<li>Release of a working prototype</li>
</ul>
</li>
<li>
<p>2.5/3 weeks (will result in alpha release)</p>

<ul>
<li>Complete product development</li>
<li>Documentation of development process</li>
</ul>
</li>
<li>
<p>2.5/3 weeks (will result in beta release)</p>

<ul>
<li>Testing</li>
<li>Fixing unexpected behaviour</li>
<li>Complete documentation</li>
</ul>
</li>
</ul>

<hr>

<h2>
<a name="future-documentation-content" class="anchor" href="#future-documentation-content"><span class="octicon octicon-link"></span></a>Future documentation content</h2>

<ol>
<li>Title</li>
<li>Badges</li>
<li>One liner</li>
<li>Dependencies</li>
<li>Install</li>
<li>Use</li>
<li>Documentation

<ol>
<li>Problem</li>
<li>Solution</li>
<li>Introduction

<ul>
<li>Async and sync</li>
<li>Small examples

<ul>
<li>Not wanted</li>
<li>Wanted</li>
</ul>
</li>
</ul>
</li>
<li>Full example covering complete usage (API)</li>
<li>Individual components</li>
</ol>
</li>
<li>Example usage</li>
</ol>

<hr>

<h2>
<a name="documentation-outdated" class="anchor" href="#documentation-outdated"><span class="octicon octicon-link"></span></a>Documentation (outdated)</h2>

<h3>
<a name="problem-to-be-solved" class="anchor" href="#problem-to-be-solved"><span class="octicon octicon-link"></span></a>Problem to be solved</h3>

<p>Writing asynchronous, maintainable, modular and loosely coupled programs in Node.js without some help from a library/framework is hard (if you do not want to end up with 'christmas tree' code which will get you into (callback) hell).</p>

<h3>
<a name="how-is-f_-going-to-solve-this-problem" class="anchor" href="#how-is-f_-going-to-solve-this-problem"><span class="octicon octicon-link"></span></a>How is <code>f_</code> going to solve this problem?</h3>

<p>Allow programmers to use a Node.js module with a simple API which will make separation of concerns (which results in loosely coupled programs), modular and asynchronous programming a breeze.</p>

<h3>
<a name="introduction" class="anchor" href="#introduction"><span class="octicon octicon-link"></span></a>Introduction</h3>

<p>Every (large) Node.js program has lots of asynchronous tasks such as:</p>

<ul>
<li>HTTP requests</li>
<li>Complex equation solving</li>
<li>Audio/video compressing</li>
</ul>

<p>Ofcourse small tasks in larger asynchronous tasks will be synchronous. Some examples are:</p>

<ul>
<li>Concatenating a string</li>
<li>solving simple equations</li>
<li>Declaring variables</li>
</ul>

<p>When we look at the two lists above, we can categorize computational tasks into two separate groups:</p>

<ol>
<li>Asynchronous (either simple and quick or complex and long lasting)</li>
<li>Synchronous (only simple and quick)</li>
</ol>



<h3>
<a name="api" class="anchor" href="#api"><span class="octicon octicon-link"></span></a>API</h3>

<p>Everything <code>f_</code> offers will be used in the code example below. We will be using a class based approach (plain object not recommended). Since we will be initiating a lot of instances, so we will make use of JavaScript it's prototypal inheritance pattern.</p>

<div class="highlight highlight-js"><pre>
<span class="c1">// EDIT THIS WITH NEW API / PROTO ASSIGMENT</span>

<span class="kd">var</span> <span class="nx">f_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'f_'</span><span class="p">);</span>

<span class="cm">/** Class based TaskList.</span>
<span class="cm"> * All methods are written in this class</span>
<span class="cm"> * @class TaskList      Class which holds all methods, used to set data</span>
<span class="cm"> *                      on initialization</span>
<span class="cm"> * @arg o.url {string}  Url to grab source code from</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">TaskList</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">TaskList</span> <span class="p">(</span><span class="nx">o</span><span class="p">){</span>
  <span class="nx">o</span> <span class="o">=</span> <span class="nx">o</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Create an empty namespace object to hold our proto(type) methods</span>
<span class="cm"> * Which will be assigned to the TaskList its prototype object</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">proto</span> <span class="o">=</span> <span class="p">{};</span>

<span class="cm">/**</span>
<span class="cm"> * @method start  Check if requirements are met</span>
<span class="cm"> */</span>
<span class="nx">proto</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>

<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * @method getSource          Gets a website source code</span>
<span class="cm"> * @req    url {string}  Url to grab source code from</span>
<span class="cm"> * @data   d.source {string}  Website it's source code</span>
<span class="cm"> */</span>
<span class="nx">proto</span><span class="p">.</span><span class="nx">getSource</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>

<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * @method writeSource        Writes a source code on HD</span>
<span class="cm"> * @req    d.source {string}  Website it's source page</span>
<span class="cm"> */</span>
<span class="nx">proto</span><span class="p">.</span><span class="nx">writeSource</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>

<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * @method notify  Log what happened in the previous methods</span>
<span class="cm"> */</span>
<span class="nx">proto</span><span class="p">.</span><span class="nx">notify</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>

<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * Adding data to Class proto object, it will be same with every instance.</span>
<span class="cm"> * No need to add it to our shared data object namespace, which could be reset.</span>
<span class="cm"> * Also using the prototype object, we only assign it once.</span>
<span class="cm"> */</span>
<span class="nx">proto</span><span class="p">.</span><span class="nx">writeDir</span> <span class="o">=</span> <span class="s1">'./sourceCodes'</span><span class="p">;</span>


<span class="cm">/**</span>
<span class="cm"> * Assign methods from proto object to our TaskList its actual</span>
<span class="cm"> * prototype object.</span>
<span class="cm"> * Ofcourse, make sure our proto object has all properties we want it</span>
<span class="cm"> * to have before we assign it!</span>
<span class="cm"> */</span>
<span class="nx">TaskList</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">proto</span><span class="p">;</span>


<span class="cm">/** f_config object</span>
<span class="cm"> * In this object we can tell f_ what to do.</span>
<span class="cm"> * It can be quite detailed. But only a few properties are actualy</span>
<span class="cm"> * required for f_ to work</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">f_config</span> <span class="o">=</span> <span class="p">{</span>

  <span class="c1">// Function order f_ uses to call methods</span>
  <span class="c1">// REQUIRED to atleast have one element!</span>
  <span class="nx">functionFlow</span><span class="o">:</span> <span class="p">[</span><span class="s1">'getSource'</span><span class="p">,</span> <span class="s1">'writeSource'</span><span class="p">,</span> <span class="s1">'notify'</span><span class="p">],</span>

  <span class="c1">// Name given to the errors array</span>
  <span class="c1">// default: errs</span>
  <span class="nx">errorArray</span><span class="o">:</span> <span class="s1">'errs'</span><span class="p">,</span> 

  <span class="c1">// Do we want a data reset when we use 'retryAll'. Can be changed later on</span>
  <span class="c1">// in our code ofcourse!</span>
  <span class="c1">// Default: false</span>
  <span class="nx">resetOnRetryAll</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

  <span class="c1">// Object in which we store our shared data.</span>
  <span class="c1">// Default: 'd'</span>
  <span class="nx">dataNamespace</span><span class="o">:</span> <span class="s1">'d'</span><span class="p">,</span>

  <span class="c1">// Data namespace properties to keep on reset.</span>
  <span class="nx">keepOnReset</span><span class="o">:</span> <span class="p">[</span><span class="s1">'testNamespace'</span><span class="p">],</span>

  <span class="c1">// How many times f_ will retry the whole task list</span>
  <span class="c1">// Default: 10</span>
  <span class="nx">maxRetriesAll</span><span class="o">:</span> <span class="mi">15</span><span class="p">,</span>

  <span class="c1">// How many times f_ will retry a single method</span>
  <span class="c1">// Default: 10</span>
  <span class="nx">maxMethodRetries</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>

  <span class="c1">// Specific methods will be retried specified times.</span>
  <span class="c1">// Will override maxMethodRetries</span>
  <span class="nx">maxMethodRetriesByName</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">getSource</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nx">writeSource</span><span class="o">:</span> <span class="mi">5</span>
  <span class="p">},</span>

  <span class="c1">// What to log</span>
  <span class="c1">// start:   If first method in functionFlow is called</span>
  <span class="c1">// next:    A method is called, we log the method name.</span>
  <span class="c1">// retry:   A retry occurs, log everything known about it.</span>
  <span class="c1">// error:   An error gets pushed to errs array, log err description and</span>
  <span class="c1">//          origional error object.</span>
  <span class="c1">// abort:   f_ aborts a task list, log error stack and method</span>
  <span class="c1">//          which caused error.</span>
  <span class="c1">// finish:  Log when tasks is complete and time taken</span>
  <span class="c1">// all:     Log 'everything' f_ does, all above triggers will be true.</span>
  <span class="c1">// silent:  Log nothing at all.</span>
  <span class="c1">// Default: ['all']</span>
  <span class="nx">toLog</span><span class="o">:</span> <span class="p">[</span><span class="s1">'next'</span><span class="p">,</span> <span class="s1">'retry'</span><span class="p">]</span>

<span class="p">};</span>

<span class="c1">// 'augment' method takes two arguments: object/class to augment and</span>
<span class="c1">// a config object.</span>
<span class="nx">TaskList</span> <span class="o">=</span> <span class="nx">f_</span><span class="p">.</span><span class="nx">augment</span><span class="p">(</span><span class="nx">TaskList</span><span class="p">,</span> <span class="nx">f_config</span><span class="p">);</span>

<span class="c1">// Initiate 100 instances </span>
<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">1</span><span class="p">){</span>
  <span class="c1">// Provide data which will be set to the instance it's properties.</span>
  <span class="kd">var</span> <span class="nx">tasksInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TaskList</span><span class="p">();</span>
  <span class="nx">tasksInstance</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">tasksInstance</span><span class="p">.</span><span class="nx">errs</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Ok, everything has started correctly, task:'</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Errors at start, probably we do not want to continue w/'</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<h3>
<a name="in-depth-look-at-the-way-f_-doesnt-work" class="anchor" href="#in-depth-look-at-the-way-f_-doesnt-work"><span class="octicon octicon-link"></span></a>In depth look at the way <code>f_</code> DOESN'T work.</h3>

<p>When we are looking at the way Node handles asynchronous computation, we are looking at the simple to grasp and understand, yet powerful practice of callbacks. Whilst this practice may be simple, code management, separation of concerns and loose coupling can be diffucult to achieve. This is due to something called 'callback hell'. Which will result in 'christmas tree code'. An (ugly) example below:</p>

<div class="highlight highlight-js"><pre><span class="cm">/**</span>
<span class="cm"> * Simple task which will first GET google.com source code, write it to a HTML</span>
<span class="cm"> * file. When those two tasks are complete it will GET google.nl source code</span>
<span class="cm"> * and also write that to a HTML file. Written the most ugly way possible,</span>
<span class="cm"> * we're not even using named function declaration above the the async logic.</span>
<span class="cm"> */</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'http://www.google.com'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">googleRes</span><span class="p">){</span>

  <span class="kd">var</span> <span class="nx">googleSource</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

  <span class="nx">googleRes</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">googleChunk</span><span class="p">){</span>
    <span class="nx">googleSource</span> <span class="o">=</span> <span class="nx">googleSource</span> <span class="o">+</span> <span class="nx">googleChunk</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">googleRes</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(){</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="s1">'googleSource.html'</span><span class="p">,</span> <span class="nx">googleSource</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">googleWriteErr</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">googleWriteErr</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">googleWriteErr</span><span class="p">);</span>

      <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'http://www.youtube.com'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ytRes</span><span class="p">){</span>

        <span class="kd">var</span> <span class="nx">ytSource</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

        <span class="nx">ytRes</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ytChunk</span><span class="p">){</span>
          <span class="nx">ytSource</span> <span class="o">=</span> <span class="nx">ytSource</span> <span class="o">+</span> <span class="nx">ytChunk</span><span class="p">;</span>
        <span class="p">});</span>

        <span class="nx">ytRes</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(){</span>
          <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="s1">'ytSource.html'</span><span class="p">,</span> <span class="nx">ytSource</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ytWriteErr</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">ytWriteErr</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ytWriteErr</span><span class="p">);</span>

            <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Tasks complete!'</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<p>As you can see, this code hard to read, write and maintain. We're not even taking error handling and dependecy management in account here... Which will make it even harder to read, write and maintain.</p>

<h3>
<a name="in-depth-look-at-the-way-f_-does-work" class="anchor" href="#in-depth-look-at-the-way-f_-does-work"><span class="octicon octicon-link"></span></a>In depth look at the way <code>f_</code> DOES work.</h3>

<p>Let's take a look at the way I want to write this simple task!</p>

<div class="highlight highlight-js"><pre><span class="cm">/**</span>
<span class="cm"> * Please note we're still not using a good error handling mehtod,</span>
<span class="cm"> * the same logic as the ugly example is used.</span>
<span class="cm"> */</span>

<span class="nx">proto</span><span class="p">.</span><span class="nx">getGoogle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'http://www.google.com'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">){</span>

    <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">){</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span> <span class="o">+</span> <span class="nx">chunk</span><span class="p">;</span> <span class="p">});</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(){</span>
      <span class="c1">// Using the d object namespace to store data we</span>
      <span class="c1">// need to use in other/later function scopes</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">googleSource</span> <span class="o">=</span> <span class="nx">source</span><span class="p">;</span>

      <span class="c1">// return statement isn't necessary, using it to show we're</span>
      <span class="c1">// done with this task.</span>
      <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
    <span class="p">});</span>

  <span class="p">});</span>
<span class="p">};</span>


<span class="nx">proto</span><span class="p">.</span><span class="nx">writeGoogle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">googleSource</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">googleSource</span><span class="p">;</span>

  <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="s1">'googleSource.html'</span><span class="p">,</span> <span class="nx">googleSource</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
  <span class="p">});</span>

<span class="p">};</span>

<span class="nx">proto</span><span class="p">.</span><span class="nx">getYt</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'http://www.youtube.com'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">){</span>

    <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">){</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span> <span class="o">+</span> <span class="nx">chunk</span><span class="p">;</span> <span class="p">});</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">ytSource</span> <span class="o">=</span> <span class="nx">source</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
    <span class="p">});</span>

  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">proto</span><span class="p">.</span><span class="nx">writeYt</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">ytSource</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">ytSource</span><span class="p">;</span>

  <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="s1">'ytSource.html'</span><span class="p">,</span> <span class="nx">ytSource</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

    <span class="c1">// Using next when there are no more tasks will result in a low</span>
    <span class="c1">// level f_ API 'f_.finish' method call. Clearing up used memory, etc..</span>
    <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
  <span class="p">});</span>

<span class="p">};</span>
</pre></div>

<p>Yes, we did it; separation of concerns and loose coupling! We could even modularize (litteraly) it, since all those smaller asynchronous tasks could be single modules, if wanted they can even be put in single files. In this case I would keep it in a single file, since all tasks are small and easy to read/maintain. Even though we are using more lines of code.</p>

<p>So far we can say that <code>f_</code> will allow us to program in a modularized way. Which is great already! Well, more greatness is coming your way!</p>

<p>Now let's take a look at the way we will be handling errors (using a piece of the previous example):</p>

<div class="highlight highlight-js"><pre><span class="cm">/**</span>
<span class="cm"> * In this piece of code, we will catch error messages so we can display</span>
<span class="cm"> * the complete error stack when the task is aborted, or when we look up</span>
<span class="cm"> * the f_ 'errs' array filled with error objects.</span>
<span class="cm"> */</span>
<span class="nx">proto</span><span class="p">.</span><span class="nx">getGoogle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'http://www.google.com'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">){</span>

    <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">){</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span> <span class="o">+</span> <span class="nx">chunk</span><span class="p">;</span> <span class="p">});</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">googleSource</span> <span class="o">=</span> <span class="nx">source</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
    <span class="p">});</span>

  <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="c1">// We provide a custom error message string and the original err object</span>
    <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">addErr</span><span class="p">(</span><span class="s1">'http.get error'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>


<span class="nx">proto</span><span class="p">.</span><span class="nx">writeGoogle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">googleSource</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">googleSource</span><span class="p">;</span>

  <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="s1">'googleSource.html'</span><span class="p">,</span> <span class="nx">googleSource</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="c1">// Same as with http.get</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">addErr</span><span class="p">(</span><span class="s1">'fs.writeFile error'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
  <span class="p">});</span>

<span class="p">};</span>
</pre></div>

<p>So we've got a way to create an error stack, now we need a way to do something when an error occurs. This could ofcourse be done traditionally with 
<code>on('error')</code> event listeners. The problem with that is, we cannot directly 'throw' in a retry when something fails. Writing <code>on('error')</code> listeners everytime is tedious. Something we try to remove from programming Node programs (don't forget you CAN still use them!). So with <code>f_</code> we can do it directly from a piece of code that causes an error. Take a look at this example:</p>

<div class="highlight highlight-js"><pre><span class="c1">// Immediately retry this asynchronous part of a larger task list</span>
<span class="nx">proto</span><span class="p">.</span><span class="nx">getGoogle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'http://www.google.com'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">){</span>
    <span class="c1">// ...</span>
  <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="c1">// With this function call we still add errors to the stack,</span>
    <span class="c1">// but immediately retry the current function</span>
    <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">retryThis</span><span class="p">(</span><span class="s1">'http.get error'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
</pre></div>

<p>Let's say we use the source code received from Google.com in a later function but the <code>GET</code> request fails the first time, we want to make sure every piece of data we stored is removed from our RAM. We need a way to make <code>f_</code> know what data to remove from the data namespace object. We can do this by manualy providing <code>f_</code> with objects.</p>

<div class="highlight highlight-js"><pre><span class="nx">proto</span><span class="p">.</span><span class="nx">getGoogle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'http://www.google.com'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">googleSource</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">){</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">googleSource</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">googleSource</span> <span class="o">+</span> <span class="nx">chunk</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(){</span>
      <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
    <span class="p">});</span>

  <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="c1">// Providing 'dataToReset' with an object, f_ will reset properties</span>
    <span class="c1">// with given values when we use the retryThis method</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">dataToReset</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">googleSource</span><span class="o">:</span> <span class="s1">''</span> <span class="p">};</span>

    <span class="c1">// The following syntax is also supported, this way we can reset</span>
    <span class="c1">// objects deeper in the data namespace object</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">dataToReset</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'dataObjectNamespace.someProperty'</span><span class="o">:</span> <span class="p">{}</span> <span class="p">}</span>

    <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">retryThis</span><span class="p">(</span><span class="s1">'http.get error'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
</pre></div>

<p>This way we can ensure data is removed, ofcourse you could also override properties. But this could result in unwanted and hard to find corrupted data. There also is way to make sure EVERY piece of data is removed from our data object namespace: <code>self.resetAllData();</code></p>

<p>So far we've talked about the data object namespace quite a lot. Let's take a closer look at how it works. We used the <code>d</code> namespace in our examples. This is just a plain JS object. With <code>f_</code> we can set our data object like this: <code>self.setDataObject('d')</code> or like this: <code>self.d = {};</code>. If you want more namespaces, simply do the following:
<code>self.d.newNameSpace = {}</code>. 
Please note that when you use the <code>self.resetAllData();</code> all namespaces in the top level namespace will be cleared. In case this is unwanted there is a way to let <code>f_</code> know we want to keep certain properties in our main namespace: 
<code>self.keepOnReset = ['newNameSpace'];</code>. There might even be cases where you don't want to reset anything at all, use: <code>self.resetOnRetry = false;</code></p>

<ul>
<li>DISCUSS: <code>retryAll(optErrMsgString, optErrObj);</code>
</li>
<li>DISCUSS: <code>retryThis(optErrMsgString, optErrObj);</code>
</li>
</ul>

<p>Let's put everything in a part of a 'real world' code example:</p>

<div class="highlight highlight-js"><pre><span class="cm">/**</span>
<span class="cm"> * When using f_, I tend to use 'start' as a function which will check</span>
<span class="cm"> * for dependencies and as a setup.</span>
<span class="cm"> */</span>
<span class="nx">proto</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="c1">// ... dependency verification could/should be here ...</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">setDataObject</span><span class="p">(</span><span class="s1">'d'</span><span class="p">);</span>
  <span class="c1">// ^ Could also be written like this: self.d = {};</span>
  <span class="c1">// might result in overriding data, since setDataObject won't</span>
  <span class="c1">// change the property if it's set already</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">newNameSpace</span> <span class="o">=</span> <span class="p">{};</span>       <span class="c1">// this one will be kept</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">someOtherNamespace</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// this one will be removed</span>

  <span class="c1">// Which properties to keep when we use a reset</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">keepOnReset</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'newNameSpace'</span><span class="p">];</span>

  <span class="c1">// Do we actualy want a data reset? In this case; true!</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">resetOnRetry</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

<span class="p">};</span>

<span class="nx">proto</span><span class="p">.</span><span class="nx">getGoogle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">googleSource</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">){</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">googleSource</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">googleSource</span> <span class="o">+</span> <span class="nx">chunk</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(){</span>
    <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
  <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="c1">// With this function call we still add errors to the stack,</span>
    <span class="c1">// but immediately retry the current function</span>
    <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">retryThis</span><span class="p">(</span><span class="s1">'http.get error'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
  <span class="p">});</span>

<span class="p">};</span>

<span class="nx">proto</span><span class="p">.</span><span class="nx">writeGoogle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="c1">// Check if the required data is present. In case it isn't,</span>
  <span class="c1">// we retry our whole task list</span>
<span class="p">};</span>

</pre></div>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">f_ maintained by <a href="https://github.com/opensoars">opensoars</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
